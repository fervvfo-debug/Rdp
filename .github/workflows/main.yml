name: Win-11-128Cores-32GB-512SSD-RDP-Ngrok

on:
  workflow_dispatch:

jobs:
  win-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}

    steps:
    - name: Print system info
      shell: powershell
      run: |
        Write-Host "=== SYSTEM INFO ==="
        $info = Get-CimInstance Win32_ComputerSystem
        $ram = [math]::Round($info.TotalPhysicalMemory/1GB,2)
        Write-Host "RAM: $ram GB"

        $cpu = (Get-CimInstance Win32_Processor | Measure-Object -Property NumberOfLogicalProcessors -Sum).Sum
        Write-Host "Cores: $cpu"

        $disk = Get-PSDrive C
        $diskGB = [math]::Round(($disk.Used + $disk.Free)/1GB,2)
        Write-Host "Disk: $diskGB GB"

    - name: Install ngrok
      shell: powershell
      run: |
        $path = "$env:USERPROFILE\ngrok"
        if (!(Test-Path $path)) { New-Item -ItemType Directory -Path $path | Out-Null }
        $zip = "$path\ngrok.zip"

        Write-Host "Downloading ngrok..."
        iwr "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile $zip -UseBasicParsing

        Expand-Archive $zip -DestinationPath $path -Force
        Remove-Item $zip -Force

        Write-Host "ngrok installed."

    - name: Configure ngrok
      shell: powershell
      run: |
        $ngrok = "$env:USERPROFILE\ngrok\ngrok.exe"

        if (!(Test-Path $ngrok)) {
          throw "Ngrok missing!"
        }

        if ($env:NGROK_AUTHTOKEN) {
          & $ngrok authtoken $env:NGROK_AUTHTOKEN
        } else {
          Write-Warning "NGROK_AUTHTOKEN missing!"
        }

    - name: Enable RDP
      shell: powershell
      run: |
        Write-Host "Enabling RDP..."

        Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0

        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue

        sc.exe config TermService start= auto
        Start-Service TermService -ErrorAction SilentlyContinue

        Write-Host "RDP enabled."

    - name: Create RDP user
      shell: powershell
      run: |
        $user = "rdpuser"

        if (!$env:RDP_PASSWORD) {
          $pw = "Rdp12345!"
          Write-Warning "RDP_PASSWORD not set. Using fallback!"
        } else {
          $pw = $env:RDP_PASSWORD
        }

        $secPw = ConvertTo-SecureString $pw -AsPlainText -Force

        if (!(Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
          New-LocalUser -Name $user -Password $secPw
        } else {
          Set-LocalUser -Name $user -Password $secPw
        }

        Add-LocalGroupMember -Group administrators -Member $user -ErrorAction SilentlyContinue
        Write-Host "RDP user ready."

    - name: Start ngrok tunnel
      shell: powershell
      run: |
        $ngrok = "$env:USERPROFILE\ngrok\ngrok.exe"
        Start-Process $ngrok -ArgumentList "tcp 3389" -WindowStyle Hidden

        Write-Host "Waiting for ngrok (15s)..."
        Start-Sleep 15

        try {
          $api = Invoke-RestMethod "http://127.0.0.1:4040/api/tunnels"
          $url = $api.tunnels.public_url
          Write-Host "===================================="
          Write-Host "   RDP ADDRESS: $url"
          Write-Host "   USER: rdpuser"
          Write-Host "   PASS: (your secret)"
          Write-Host "===================================="
        } catch {
          Write-Warning "Ngrok API not ready yet."
        }

    - name: Keep alive
      shell: powershell
      run: |
        Write-Host "Session alive. Press CTRL+C to stop."
        while ($true) { Start-Sleep 60 }
