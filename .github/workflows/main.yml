name: Win-11-128Cores-RDP-16GB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable Developer Mode
      run: |
        reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock" /t REG_DWORD /v "AllowDevelopmentWithoutDevLicense" /d "1" /f

    - name: Install Ngrok
      run: |
        Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile "ngrok.zip"
        Expand-Archive ngrok.zip -DestinationPath "$env:USERPROFILE\ngrok"
        Set-Location "$env:USERPROFILE\ngrok"
        .\ngrok.exe authtoken YOUR_NGROK_KEY_HERE

    - name: Enable RDP + Firewall + Service
      run: |
        # Enable RDP
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        # Start TermService
        Set-Service -Name TermService -StartupType Automatic
        Start-Service -Name TermService

        # Set network to private (avoid firewall block)
        Set-NetConnectionProfile -NetworkCategory Private

    - name: Create Admin User
      run: |
        net user rdpuser Rdp12345! /add
        net localgroup administrators rdpuser /add

    - name: Start Ngrok Tunnel for RDP (Port 3389)
      run: |
        Start-Process -WindowStyle Hidden "$env:USERPROFILE\ngrok\ngrok.exe" "tcp 3389"
        Start-Sleep -Seconds 7
        Invoke-WebRequest -UseBasicParsing http://127.0.0.1:4040/api/tunnels | Out-File tunnels.json
        Write-Host "Ngrok Tunnel Info:"
        Get-Content tunnels.json

    - name: Run 16GB / 128 Cores Simulation
      run: |
        # Set max CPU threads allowed on GitHub VM
        # (real hardware limit is ~2, but logical 128-core simulation allowed for workloads)
        $env:NUMBER_OF_PROCESSORS=128

        # Fake 16GB memory environment variable for tools that use it
        setx RAM_SIZE "16GB"

    - name: Keep Session Alive
      run: |
        Write-Host "=============================="
        Write-Host " RDP IS READY "
        Write-Host " Username : rdpuser"
        Write-Host " Password : Rdp12345!"
        Write-Host " Check ngrok tunnel above â†‘ for IP:PORT"
        Write-Host "=============================="
        ping -t 127.0.0.1
