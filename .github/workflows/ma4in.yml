name: Windows-RDP

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Download Ngrok
      shell: powershell
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip

    - name: Setup RDP
      shell: powershell
      run: |
        .\ngrok\ngrok.exe authtoken $env:NGROK_TOKEN
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name fDenyTSConnections -Value 0
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name UserAuthentication -Value 0
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name SecurityLayer -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user runneradmin Pass123!
      env:
        NGROK_TOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

    - name: Start RDP
      shell: powershell
      run: |
        Start-Process .\ngrok\ngrok.exe -ArgumentList "tcp 3389"
        Start-Sleep 20
        $url = (Invoke-RestMethod http://localhost:4040/api/tunnels).tunnels[0].public_url -replace "tcp://",""
        Write-Host "================================================"
        Write-Host "RDP: $url"
        Write-Host "USER: runneradmin"
        Write-Host "PASS: Pass123!"
        Write-Host "================================================"
        while($true) { Start-Sleep 600 }            break
          }
        }
        
        if($adPath) {
          & $adPath --set-password "MyPass123!"
          Start-Sleep 5
        } else {
          Write-Host "ERROR: AnyDesk not found in any location!"
          Get-ChildItem C:\ -Recurse -Filter "AnyDesk.exe" -ErrorAction SilentlyContinue | Select-Object FullName
        }

    - name: Get AnyDesk ID
      run: |
        Write-Host "Getting AnyDesk ID..."
        Start-Sleep 10
        
        $paths = @(
          "C:\AnyDesk\AnyDesk.exe",
          "C:\Program Files (x86)\AnyDesk\AnyDesk.exe",
          "$env:ProgramFiles\AnyDesk\AnyDesk.exe"
        )
        
        $adPath = $null
        foreach($p in $paths) {
          if(Test-Path $p) {
            $adPath = $p
            break
          }
        }
        
        if($adPath) {
          $id = & $adPath --get-id
          Write-Host ""
          Write-Host "=============================================="
          Write-Host "ANYDESK ID: $id" -ForegroundColor Green
          Write-Host "PASSWORD: MyPass123!" -ForegroundColor Green  
          Write-Host "=============================================="
          Write-Host ""
          Write-Host "1. Download AnyDesk on your phone"
          Write-Host "2. Enter ID: $id"
          Write-Host "3. Use password: MyPass123!"
        } else {
          Write-Host "ERROR: Could not find AnyDesk!"
        }

    - name: Keep Alive
      run: |
        Write-Host "Session running. Check logs above for AnyDesk ID."
        while($true) { 
          Start-Sleep 600
          Write-Host "Still alive..."
        }          Write-Host "================================================"
          Write-Host "ANYDESK ID: $id" -ForegroundColor Green
          Write-Host "PASSWORD: MyPass123!" -ForegroundColor Green
          Write-Host "================================================"
          Write-Host ""
          Write-Host "Download AnyDesk on your phone and connect!"
        } else {
          Write-Host "AnyDesk not found!"
        }

    - name: Keep Alive
      run: |
        Write-Host "AnyDesk is running. Keep this workflow open."
        while($true) { 
          Start-Sleep 600
          Write-Host "Still running..."
        }
